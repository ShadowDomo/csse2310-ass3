#include "2310A.h"


/** Dealer program. **/
int main(int argc, char **argv) {

    // suppose correct
    char *deckFileName = argv[1];
    char *mapFileName = argv[2];

    // first three args are not players
    int numPlayers = argc - 3;

    char *givenPath = read_line(fopen(mapFileName, "r"));
    Path *path = allocate_path(givenPath, numPlayers);
    path->players = malloc(sizeof(Player*) * numPlayers);
    path->deck = allocate_deck(fopen(deckFileName, "r"));

    for (int i = 0; i < numPlayers; ++i) {
        path->players[i] = init_player(path, i);
    }
    arrange_order_of_players(path);

//    start_dealer(path);

    int fd[2];
    int fdagain[2];
    pipe(fd);
    pipe(fdagain);

    int cPID = fork();

    if (cPID == 0) {
        // write 2310A's stdout into pipe
        dup2(fd[WRITE_END], STDOUT_FILENO);
        close(fd[WRITE_END]);
        close(fd[READ_END]);

        // 2310A reads from pipe2
        dup2(fdagain[READ_END], STDIN_FILENO);
        close(fdagain[READ_END]);
        close(fdagain[WRITE_END]);

        execl("2310A", "2310A", "2", "0", NULL);
    } else {

        // 2310A's stdout should only be Do's and a ^
//        dup2(fd[READ_END], STDIN_FILENO);
        close(fd[WRITE_END]);
        close(fdagain[READ_END]);

        // send to 2310A's in
//        dup2(fdagain[WRITE_END], );

        FILE *writer = fdopen(fdagain[WRITE_END], "w");
        FILE *fp = fdopen(fd[READ_END], "r");

        char carat = fgetc(fp);
        if (carat == '^') {
            printf("done\n");
            fprintf(writer, "%s", givenPath);
            fflush(writer);
        }

        start_dealer(path, fp, writer);



    }



}

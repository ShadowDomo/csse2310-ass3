#include "2310A.h"


/** Dealer program. **/
int main(int argc, char **argv) {

    // suppose correct
    char *deckFileName = argv[1];
    char *mapFileName = argv[2];

    // first three args are not players
    int numPlayers = argc - 3;

    // do initialisation
    char *givenPath = read_line(fopen(mapFileName, "r"));
    Path *path = allocate_path(givenPath, numPlayers);
    path->players = malloc(sizeof(Player*) * numPlayers);
    path->deck = allocate_deck(fopen(deckFileName, "r"));

    for (int i = 0; i < numPlayers; ++i) {
        path->players[i] = init_player(path, i);
        // make pipes
        pipe(path->players[i]->sendPipes);
        pipe(path->players[i]->receivePipes);
    }
    arrange_order_of_players(path);

    int fd[2];
    int fdagain[2];
    pipe(fd);
    pipe(fdagain);
//    fork();
    int cPID = fork();


    if (cPID == 0) {
        // write 2310A's stdout into pipe
        dup2(fd[WRITE_END], STDOUT_FILENO);
        close(fd[WRITE_END]);
        close(fd[READ_END]);

        // 2310A reads from pipe2
        dup2(fdagain[READ_END], STDIN_FILENO);
        close(fdagain[READ_END]);
        close(fdagain[WRITE_END]);

        // suppress stderr
        int sink = fileno(fopen("/dev/null", "w"));
        dup2(sink, STDERR_FILENO);

        // TODO fix
        execl("2310A", "2310A", "2", "0", NULL);
    } else {
        // 2310A's stdout should only be Do's and a ^
        close(fd[WRITE_END]);
        close(fdagain[READ_END]);

        // write to this to talk to player
        FILE *writer = fdopen(fdagain[WRITE_END], "w");

        // read from this to read from player
        FILE *fp = fdopen(fd[READ_END], "r");

        // need to adapt for multiple players todo
        char carat = fgetc(fp);
        if (carat == '^') {
//            printf("done\n");
            fprintf(writer, "%s\n", givenPath);
            fflush(writer);
        }

        start_dealer(path, fp, writer);



    }



}
